name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Single place to update when cutting a new release (image tag on Docker Hub)
env:
  HEAT_IMAGE_TAG: v4.2.6

jobs:
  check-final-image:
    runs-on: ubuntu-latest
    steps:
    - name: Check if final Docker image exists on Docker Hub
      id: check-final-image
      run: |
        if docker pull plasmapotential/heat:${{ env.HEAT_IMAGE_TAG }}; then
          echo "Image exists on Docker Hub."
        else
          echo "::error ::Final HEAT Docker image ${{ env.HEAT_IMAGE_TAG }} does not exist."
          exit 1 
        fi

  tests:
    needs: check-final-image
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Pull Docker image
      run: docker pull plasmapotential/heat:${{ env.HEAT_IMAGE_TAG }}

    - name: Run simple CI configuration test 
      run: docker run -v ${{ github.workspace }}:/root/source/HEAT plasmapotential/heat:${{ env.HEAT_IMAGE_TAG }} python3 /root/source/HEAT/tests/integrationTests/ciTest.py

    #test the various HEAT modules
    - name: NSTX-U Optical HEAT Calculation
      run: docker run -v ${{ github.workspace }}:/root/source/HEAT plasmapotential/heat:${{ env.HEAT_IMAGE_TAG }} /root/source/HEAT/source/runTerminalModeTestOptical
    - name: NSTX-U Optical Elmer FEM HEAT Calculation
      run: docker run -v ${{ github.workspace }}:/root/source/HEAT plasmapotential/heat:${{ env.HEAT_IMAGE_TAG }} /root/source/HEAT/source/runTerminalModeTestOpticalElmer     
    - name: NSTX-U Gyro-orbit HEAT Calculation
      run: docker run -v ${{ github.workspace }}:/root/source/HEAT plasmapotential/heat:${{ env.HEAT_IMAGE_TAG }} /root/source/HEAT/source/runTerminalModeTestGyro
    - name: NSTX-U Photon Radiation HEAT Calculation
      run: docker run -v ${{ github.workspace }}:/root/source/HEAT plasmapotential/heat:${{ env.HEAT_IMAGE_TAG }} /root/source/HEAT/source/runTerminalModeTestRad
    - name: NSTX-U RZQ File HEAT Calculation
      run: docker run -v ${{ github.workspace }}:/root/source/HEAT plasmapotential/heat:${{ env.HEAT_IMAGE_TAG }} /root/source/HEAT/source/runTerminalModeTestrzq
    - name: NSTX-U BYOM HEAT calculation
      run: docker run -v ${{ github.workspace }}:/root/source/HEAT plasmapotential/heat:${{ env.HEAT_IMAGE_TAG }} /root/source/HEAT/source/runTerminalModeTestBYOM
#    - name: DIII-D 3D Fields HEAT calculation
#      run: docker run -v ${{ github.workspace }}:/root/source/HEAT plasmapotential/heat:${{ env.HEAT_IMAGE_TAG }} /root/source/HEAT/source/runTerminalModeTest3Dfields
    
